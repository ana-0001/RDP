name: RDP-Ngrok

on:
  workflow_dispatch:
    inputs:
      runs-on:
        description: OS
        type: choice
        default: windows-2019
        options:
          - windows-2019
          - windows-latest
          - ubuntu-24.04
          - fedora-42

jobs:
  remote:
    runs-on: ${{ inputs.runs-on }}
    timeout-minutes: 216000

    steps:
    # ================= COMMON =================
    - name: Install ngrok
      shell: bash
      run: |
        if command -v apt >/dev/null; then
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com stable main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok -y
        fi

    - name: Configure ngrok
      run: ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

    # ================= WINDOWS =================
    - name: Windows RDP Setup
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

        $pass = [System.Web.Security.Membership]::GeneratePassword(16,4)
        net user RDP $pass /add
        net localgroup administrators RDP /add
        net localgroup "Remote Desktop Users" RDP /add
        echo "RDP_PASSWORD=$pass" >> $env:GITHUB_ENV

    - name: Start ngrok RDP (auto-restart)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        while ($true) {
          ngrok tcp 3389 --log=stdout
          Start-Sleep 5
        }

    # ================= LINUX =================
    - name: Linux Desktop + VNC
      if: runner.os != 'Windows'
      shell: bash
      run: |
        set -e
        sudo apt update || sudo dnf update -y

        # GNOME
        sudo apt install ubuntu-desktop-minimal tigervnc-standalone-server gnome-session gdm3 -y \
        || sudo dnf groupinstall "GNOME Desktop" -y

        # VNC
        PASS=$(openssl rand -base64 12)
        mkdir -p ~/.vnc
        echo "$PASS" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        echo "VNC_PASSWORD=$PASS" >> $GITHUB_ENV

        cat <<EOF > ~/.vnc/xstartup
        #!/bin/sh
        unset SESSION_MANAGER
        unset DBUS_SESSION_BUS_ADDRESS
        exec gnome-session &
        EOF
        chmod +x ~/.vnc/xstartup

        vncserver :1 -localhost no

    - name: Start ngrok VNC (auto-restart)
      if: runner.os != 'Windows'
      run: |
        while true; do
          ngrok tcp 5901 --log=stdout
          sleep 5
        done

    # ================= KEEP ALIVE =================
    - name: Session Alive
      run: sleep infinity
