name: RDP via Ngrok

on:
  workflow_dispatch:
    inputs:
      runs-on:
        description: "Select OS"
        required: true
        default: windows-2019
        type: choice
        options:
          - windows-2019        # Windows 10 (default)
          - windows-latest      # Windows 11
          - ubuntu-24.04        # Ubuntu 24 Server
          - ubuntu-24.04-gnome  # Ubuntu 24 GNOME
          - fedora-42

      token:
        description: "Ngrok Auth Token"
        required: true

      rdp_username:
        description: "RDP username (Windows only)"
        default: "RDP"

      rdp_password:
        description: "RDP password (Windows only)"
        default: "admin_000"

jobs:
  remote-session:
    runs-on: ${{ inputs.runs-on }}
    timeout-minutes: 216000

    steps:
    - name: Install ngrok
      shell: bash
      run: |
        curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com stable main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update
        sudo apt install ngrok -y || true

    - name: Configure ngrok token
      run: ngrok config add-authtoken ${{ inputs.token }}

    # ================= WINDOWS =================
    - name: Enable RDP (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - name: Create RDP User
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        net user ${{ inputs.rdp_username }} ${{ inputs.rdp_password }} /add
        net localgroup administrators ${{ inputs.rdp_username }} /add
        net localgroup "Remote Desktop Users" ${{ inputs.rdp_username }} /add

    - name: Start ngrok RDP tunnel
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Start-Process -NoNewWindow ngrok "tcp 3389 --log=stdout"

    # ================= LINUX =================
    - name: Setup SSH (Linux)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        sudo apt update || sudo dnf update -y
        sudo apt install openssh-server -y || sudo dnf install openssh-server -y
        sudo systemctl enable ssh
        sudo systemctl start ssh
        echo "root:root" | sudo chpasswd

    - name: Start ngrok SSH tunnel
      if: runner.os != 'Windows'
      run: ngrok tcp 22 --log=stdout

    # ================= KEEP ALIVE =================
    - name: Keep session alive
      run: |
        echo "=============================="
        echo "Ngrok tunnel is running"
        echo "Check ngrok dashboard for TCP address"
        echo "https://dashboard.ngrok.com/endpoints"
        echo "=============================="
        sleep infinity
