name: RDP-Ngrok

on:
  workflow_dispatch:
    inputs:
      runs-on:
        description: "Select OS"
        type: choice
        default: windows-2019
        options:
          - windows-2019        # Windows 10
          - windows-latest      # Windows 11
          - ubuntu-24.04        # Ubuntu GNOME
          - fedora-42

      user:
        description: "Username (Windows / Linux)"
        required: false
        default: root

      pass:
        description: "Password (leave empty = auto-generate)"
        required: false
        default: admin_000

jobs:
  remote:
    runs-on: ${{ inputs.runs-on }}
    timeout-minutes: 216000

    steps:
    # ================= COMMON =================
    - name: Prepare Credentials
      shell: bash
      run: |
        if [ -z "${{ inputs.pass }}" ]; then
          PASS=$(openssl rand -base64 14)
        else
          PASS="${{ inputs.pass }}"
        fi
        echo "REMOTE_USER=${{ inputs.user }}" >> $GITHUB_ENV
        echo "REMOTE_PASS=$PASS" >> $GITHUB_ENV

    - name: Install ngrok
      shell: bash
      run: |
        if command -v apt >/dev/null; then
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com stable main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok -y
        fi

    - name: Configure ngrok
      run: ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

    # ================= WINDOWS =================
    - name: Windows RDP Setup
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

        $u="${{ env.REMOTE_USER }}"
        $p="${{ env.REMOTE_PASS }}"

        net user $u $p /add
        net localgroup administrators $u /add
        net localgroup "Remote Desktop Users" $u /add

    - name: Start ngrok RDP (auto-reconnect)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        while ($true) {
          ngrok tcp 3389 --log=stdout
          Start-Sleep 5
        }

    # ================= LINUX =================
    - name: Linux GNOME + VNC
      if: runner.os != 'Windows'
      shell: bash
      run: |
        sudo apt update || sudo dnf update -y

        # Desktop + VNC
        sudo apt install ubuntu-desktop-minimal tigervnc-standalone-server gnome-session gdm3 -y \
        || sudo dnf groupinstall "GNOME Desktop" -y

        USERNAME=${{ env.REMOTE_USER }}
        PASSWORD=${{ env.REMOTE_PASS }}

        sudo useradd -m $USERNAME || true
        echo "$USERNAME:$PASSWORD" | sudo chpasswd
        sudo usermod -aG sudo $USERNAME || true

        mkdir -p /home/$USERNAME/.vnc
        echo "$PASSWORD" | vncpasswd -f > /home/$USERNAME/.vnc/passwd
        chmod 600 /home/$USERNAME/.vnc/passwd
        chown -R $USERNAME:$USERNAME /home/$USERNAME/.vnc

        cat <<EOF > /home/$USERNAME/.vnc/xstartup
        #!/bin/sh
        unset SESSION_MANAGER
        unset DBUS_SESSION_BUS_ADDRESS
        exec gnome-session &
        EOF
        chmod +x /home/$USERNAME/.vnc/xstartup

        sudo -u $USERNAME vncserver :1 -localhost no

    - name: Start ngrok VNC (auto-reconnect)
      if: runner.os != 'Windows'
      run: |
        while true; do
          ngrok tcp 5901 --log=stdout
          sleep 5
        done

    # ================= KEEP ALIVE =================
    - name: Keep session alive
      run: sleep infinity
