name: RDP-Ngrok

on:
  workflow_dispatch:
    inputs:
      runs-on:
        description: "Select Operating System"
        type: choice
        default: windows-2019
        options:
          - windows-2019
          - windows-latest
          - ubuntu-24.04
          - fedora-42

      user:
        description: "Username"
        default: root

      pass:
        description: "Password (empty = auto)"
        default: admin_000

jobs:
  remote:
    runs-on: ${{ inputs.runs-on }}
    timeout-minutes: 216000

    steps:
    # ==================================================
    # ðŸ” Credentials
    # ==================================================
    - name: Prepare credentials
      shell: bash
      run: |
        if [ -z "${{ inputs.pass }}" ]; then
          PASS=$(openssl rand -base64 12)
        else
          PASS="${{ inputs.pass }}"
        fi
        echo "REMOTE_USER=${{ inputs.user }}" >> $GITHUB_ENV
        echo "REMOTE_PASS=$PASS" >> $GITHUB_ENV

    # ==================================================
    # ðŸ“¦ Install ngrok (Windows)
    # ==================================================
    - name: Install ngrok (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $dir="$env:ProgramFiles\ngrok"
        mkdir $dir -Force | Out-Null
        Invoke-WebRequest `
          https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip `
          -OutFile "$env:TEMP\ngrok.zip"
        Expand-Archive "$env:TEMP\ngrok.zip" $dir -Force
        echo "$dir" | Out-File -Append $env:GITHUB_PATH

    # ==================================================
    # ðŸ“¦ Install ngrok (Linux)
    # ==================================================
    - name: Install ngrok (Linux)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        sudo apt update || true
        sudo apt install curl unzip -y || true
        curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc |
          sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com stable main" |
          sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update && sudo apt install ngrok -y

    # ==================================================
    # ðŸ” Configure ngrok
    # ==================================================
    - name: Configure ngrok
      shell: bash
      run: |
        ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

    # ==================================================
    # ðŸªŸ Windows RDP
    # ==================================================
    - name: Enable RDP (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Set-ItemProperty `
          'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
          -Name fDenyTSConnections -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

        net user $env:REMOTE_USER $env:REMOTE_PASS /add
        net localgroup administrators $env:REMOTE_USER /add
        net localgroup "Remote Desktop Users" $env:REMOTE_USER /add

    - name: Start ngrok RDP (auto reconnect)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        while ($true) {
          ngrok tcp 3389 --log=stdout
          Start-Sleep -Seconds 5
        }

    # ==================================================
    # ðŸ§ Ubuntu GNOME + VNC
    # ==================================================
    - name: Linux Desktop + VNC
      if: runner.os != 'Windows'
      shell: bash
      run: |
        sudo apt update || sudo dnf update -y || true

        sudo apt install -y \
          ubuntu-desktop-minimal \
          tigervnc-standalone-server \
          gnome-session gdm3 \
          || sudo dnf groupinstall "GNOME Desktop" -y

        sudo useradd -m $REMOTE_USER || true
        echo "$REMOTE_USER:$REMOTE_PASS" | sudo chpasswd
        sudo usermod -aG sudo $REMOTE_USER || true

        mkdir -p /home/$REMOTE_USER/.vnc
        echo "$REMOTE_PASS" | vncpasswd -f > /home/$REMOTE_USER/.vnc/passwd
        chmod 600 /home/$REMOTE_USER/.vnc/passwd
        chown -R $REMOTE_USER:$REMOTE_USER /home/$REMOTE_USER/.vnc

        cat <<EOF > /home/$REMOTE_USER/.vnc/xstartup
        #!/bin/sh
        unset SESSION_MANAGER
        unset DBUS_SESSION_BUS_ADDRESS
        exec gnome-session &
        EOF
        chmod +x /home/$REMOTE_USER/.vnc/xstartup

        sudo -u $REMOTE_USER vncserver :1 -localhost no

    - name: Start ngrok VNC (auto reconnect)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        while true; do
          ngrok tcp 5901 --log=stdout
          sleep 5
        done

    # ==================================================
    # ðŸ“¡ Show IP & Tunnel Info
    # ==================================================
    - name: Show machine info
      shell: bash
      run: |
        echo "=== SYSTEM INFO ==="
        uname -a || ver
        echo "=== IP ==="
        curl -s https://api.ipify.org || true
        echo
        echo "=== NGROK API ==="
        curl -s http://127.0.0.1:4040/api/tunnels || true

    # ==================================================
    # â™» Keep Alive (Safe)
    # ==================================================
    - name: Keep Alive
      shell: bash
      run: |
        while true; do
          echo "Runner alive..."
          sleep 3600
        done
